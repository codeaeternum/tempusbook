// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// Users & Authentication
// =============================================

model User {
  id            String   @id @default(uuid())
  firebaseUid   String   @unique @map("firebase_uid")
  username      String?  @unique
  email         String?  @unique
  phone         String?
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  avatarUrl     String?  @map("avatar_url")
  preferredLang String   @default("es") @map("preferred_lang")
  role          UserRole @default(CLIENT)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  businessMembers    BusinessMember[]
  businessClients    BusinessClient[]
  bookings           Booking[]        @relation("ClientBookings")
  sales              Sale[]           @relation("ClientSales")
  reviews            Review[]
  formResponses      FormResponse[]
  loyaltyCards       LoyaltyCard[]
  favorites          Favorite[]
  notifications      Notification[]
  waitlistEntries    WaitlistEntry[]
  vehicles           Vehicle[]        @relation("ClientVehicles")
  devices            Device[]         @relation("ClientDevices")
  workOrders         WorkOrder[]      @relation("ClientWorkOrders")
  quotations         Quotation[]      @relation("ClientQuotations")
  medicalRecords     MedicalRecord[]  @relation("ClientMedicalRecords")
  dentalCharts       DentalChart[]    @relation("ClientDentalCharts")
  prescriptions      Prescription[]   @relation("ClientPrescriptions")
  bodyCharts         BodyChart[]      @relation("ClientBodyCharts")
  clientPackages     ClientPackage[]
  purchasedGiftCards GiftCard[]       @relation("GiftCardPurchaser")
  clientAlbums       GalleryAlbum[]   @relation("ClientAlbums")

  @@map("users")
}

enum UserRole {
  PLATFORM_ADMIN
  CLIENT
  BUSINESS_USER
}

// =============================================
// Business & Categories
// =============================================

model Business {
  id             String         @id @default(uuid())
  name           String
  slug           String         @unique
  categoryId     String         @map("category_id")
  description    String?
  logoUrl        String?        @map("logo_url")
  coverUrl       String?        @map("cover_url")
  phone          String?
  email          String?
  website        String?
  latitude       Float?
  longitude      Float?
  address        String?
  city           String?
  state          String?
  country        String         @default("MX")
  timezone       String         @default("America/Mexico_City")
  currency       String         @default("MXN")
  ratingsEnabled Boolean        @default(true) @map("ratings_enabled")
  settings       Json           @default("{}")
  calendarMode   CalendarMode   @default(SHARED) @map("calendar_mode")
  status         BusinessStatus @default(ONBOARDING)
  avgRating      Float          @default(0) @map("avg_rating")
  totalReviews   Int            @default(0) @map("total_reviews")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  category            Category             @relation(fields: [categoryId], references: [id])
  members             BusinessMember[]
  businessClients     BusinessClient[]
  services            Service[]
  products            Product[]
  bookings            Booking[]
  sales               Sale[]
  cashShifts          CashShift[]
  reviews             Review[]
  businessHours       BusinessHours[]
  branches            Branch[]
  subscription        Subscription?
  loyaltyPrograms     LoyaltyProgram[]
  payments            Payment[]
  favorites           Favorite[]
  galleryItems        GalleryItem[]
  loyaltyRewards      LoyaltyReward[]
  notifications       Notification[]
  waitlistEntries     WaitlistEntry[]
  intakeFormOverrides IntakeFormOverride[]
  formTemplates       FormTemplate[]
  formResponses       FormResponse[]
  vehicles            Vehicle[]
  devices             Device[]
  workOrders          WorkOrder[]
  quotations          Quotation[]
  medicalRecords      MedicalRecord[]
  dentalCharts        DentalChart[]
  prescriptions       Prescription[]
  bodyCharts          BodyChart[]
  packages            Package[]
  clientPackages      ClientPackage[]
  giftCards           GiftCard[]
  galleryAlbums       GalleryAlbum[]

  @@index([categoryId])
  @@index([slug])
  @@index([latitude, longitude])
  @@index([city, country])
  @@map("businesses")
}

enum BusinessStatus {
  ONBOARDING
  ACTIVE
  SUSPENDED
}

enum CalendarMode {
  INDIVIDUAL
  SHARED
}

model Category {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  icon            String
  description     String?
  defaultSettings Json     @default("{}") @map("default_settings")
  enabledModules  String[] @map("enabled_modules")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  businesses Business[]

  @@map("categories")
}

model Branch {
  id         String  @id @default(uuid())
  businessId String  @map("business_id")
  name       String
  address    String?
  city       String?
  state      String?
  latitude   Float?
  longitude  Float?
  phone      String?
  isActive   Boolean @default(true) @map("is_active")

  // Relations
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  productStocks ProductStock[]
  cashShifts    CashShift[]

  @@index([businessId])
  @@map("branches")
}

// =============================================
// Team / Staff
// =============================================

model BusinessMember {
  id         String       @id @default(uuid())
  businessId String       @map("business_id")
  userId     String       @map("user_id")
  role       BusinessRole @default(EMPLOYEE)
  isActive   Boolean      @default(true) @map("is_active")
  color      String? // Calendar color
  createdAt  DateTime     @default(now()) @map("created_at")

  // Relations
  business      Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings      Booking[]       @relation("StaffBookings")
  sales         Sale[]          @relation("StaffSales")
  openedShifts  CashShift[]     @relation("OpenedShifts")
  closedShifts  CashShift[]     @relation("ClosedShifts")
  businessHours BusinessHours[]
  services      StaffService[]

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@map("business_members")
}

model StaffService {
  businessMemberId String  @map("business_member_id")
  serviceId        String  @map("service_id")
  isPrimary        Boolean @default(true) @map("is_primary")

  member  BusinessMember @relation(fields: [businessMemberId], references: [id], onDelete: Cascade)
  service Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([businessMemberId, serviceId])
  @@index([serviceId])
  @@map("staff_services")
}

enum BusinessRole {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

// =============================================
// Client Relationship CRM
// =============================================

model BusinessClient {
  id          String       @id @default(uuid())
  businessId  String       @map("business_id")
  userId      String       @map("user_id")
  status      ClientStatus @default(ACTIVE)
  notes       String?      @db.Text
  clientSince DateTime     @default(now()) @map("client_since")
  metadata    Json         @default("{}")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@map("business_clients")
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  VIP
  BLOCKED
}

// =============================================
// Services & Products
// =============================================

model Service {
  id                String   @id @default(uuid())
  businessId        String   @map("business_id")
  name              String
  description       String?
  durationMinutes   Int      @map("duration_minutes")
  price             Decimal  @db.Decimal(10, 2)
  currency          String   @default("MXN")
  requiresDeposit   Boolean  @default(false) @map("requires_deposit")
  depositAmount     Decimal? @map("deposit_amount") @db.Decimal(10, 2)
  bufferTimeMinutes Int      @default(0) @map("buffer_time_minutes")
  allowOverlapping  Boolean  @default(false) @map("allow_overlapping")
  isGroup           Boolean  @default(false) @map("is_group")
  maxCapacity       Int?     @map("max_capacity")
  isActive          Boolean  @default(true) @map("is_active")
  sortOrder         Int      @default(0) @map("sort_order")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  business        Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  saleItems       SaleItem[]
  staff           StaffService[]
  waitlistEntries WaitlistEntry[]
  packages        Package[]

  @@index([businessId])
  @@map("services")
}

model Product {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  categoryId  String?  @map("category_id")
  name        String
  description String?
  sku         String?
  barcode     String?
  costPrice   Decimal? @map("cost_price") @db.Decimal(10, 2)
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("MXN")
  imageUrl    String?  @map("image_url")
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business  Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stocks    ProductStock[]
  saleItems SaleItem[]

  @@index([businessId])
  @@map("products")
}

model ProductStock {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  branchId  String   @map("branch_id")
  quantity  Int      @default(0)
  minStock  Int      @default(5) @map("min_stock")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([productId, branchId])
  @@index([branchId])
  @@map("product_stocks")
}

// =============================================
// Bookings & Calendar
// =============================================

model Booking {
  id                String        @id @default(uuid())
  businessId        String        @map("business_id")
  clientId          String        @map("client_id")
  serviceId         String        @map("service_id")
  staffId           String?       @map("staff_id")
  branchId          String?       @map("branch_id")
  startTime         DateTime      @map("start_time")
  endTime           DateTime      @map("end_time")
  status            BookingStatus @default(PENDING)
  clientNotes       String?       @map("client_notes")
  staffNotes        String?       @map("staff_notes")
  categoryData      Json          @default("{}") @map("category_data")
  intakeFormData    Json?         @map("intake_form_data")
  reminderSent      Boolean       @default(false) @map("reminder_sent")
  confirmedByClient Boolean       @default(false) @map("confirmed_by_client")
  rescheduleCount   Int           @default(0) @map("reschedule_count")
  cancelledAt       DateTime?     @map("cancelled_at")
  cancelReason      String?       @map("cancel_reason")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  business        Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client          User             @relation("ClientBookings", fields: [clientId], references: [id])
  service         Service          @relation(fields: [serviceId], references: [id])
  staff           BusinessMember?  @relation("StaffBookings", fields: [staffId], references: [id])
  branch          Branch?          @relation(fields: [branchId], references: [id])
  payments        Payment[]
  review          Review?
  packageSessions PackageSession[]

  @@index([businessId, startTime])
  @@index([clientId])
  @@index([staffId])
  @@index([status])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model BusinessHours {
  id         String    @id @default(uuid())
  businessId String    @map("business_id")
  staffId    String?   @map("staff_id")
  dayOfWeek  DayOfWeek @map("day_of_week")
  openTime   String    @map("open_time") // HH:mm
  closeTime  String    @map("close_time") // HH:mm
  isActive   Boolean   @default(true) @map("is_active")

  // Relations
  business Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  staff    BusinessMember? @relation(fields: [staffId], references: [id])

  @@index([businessId])
  @@map("business_hours")
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model WaitlistEntry {
  id            String         @id @default(uuid())
  businessId    String         @map("business_id")
  clientId      String         @map("client_id")
  serviceId     String         @map("service_id")
  preferredDate DateTime?      @map("preferred_date")
  status        WaitlistStatus @default(WAITING)
  notifiedAt    DateTime?      @map("notified_at")
  expiresAt     DateTime?      @map("expires_at")
  createdAt     DateTime       @default(now()) @map("created_at")

  // Relations
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   User     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([businessId, status])
  @@map("waitlist_entries")
}

enum WaitlistStatus {
  WAITING
  OFFERED
  ACCEPTED
  EXPIRED
}

// =============================================
// Payments & Subscriptions
// =============================================

model Payment {
  id             String        @id @default(uuid())
  bookingId      String?       @map("booking_id")
  saleId         String?       @map("sale_id")
  businessId     String        @map("business_id")
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("MXN")
  type           PaymentType   @default(FULL)
  status         PaymentStatus @default(PENDING)
  method         PaymentMethod @default(CASH)
  mpPaymentId    String?       @map("mp_payment_id")
  mpPreferenceId String?       @map("mp_preference_id")
  mpResponse     Json?         @map("mp_response")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  booking  Booking? @relation(fields: [bookingId], references: [id])
  sale     Sale?    @relation(fields: [saleId], references: [id])
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([bookingId])
  @@map("payments")
}

enum PaymentType {
  DEPOSIT
  FULL
  TIP
  REFUND
}

enum PaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model Subscription {
  id                 String             @id @default(uuid())
  businessId         String             @unique @map("business_id")
  plan               SubscriptionPlan   @default(FREE)
  status             SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?          @map("trial_ends_at")
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  mpSubscriptionId   String?            @map("mp_subscription_id")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  PAST_DUE
  CANCELLED
}

// =============================================
// Point of Sale (POS)
// =============================================

model CashShift {
  id           String      @id @default(uuid())
  businessId   String      @map("business_id")
  branchId     String?     @map("branch_id")
  openedById   String      @map("opened_by_id")
  closedById   String?     @map("closed_by_id")
  status       ShiftStatus @default(OPEN)
  openedAt     DateTime    @default(now()) @map("opened_at")
  closedAt     DateTime?   @map("closed_at")
  startingCash Decimal     @default(0) @map("starting_cash") @db.Decimal(10, 2)
  expectedCash Decimal?    @map("expected_cash") @db.Decimal(10, 2)
  actualCash   Decimal?    @map("actual_cash") @db.Decimal(10, 2)
  notes        String?

  // Relations
  business Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  branch   Branch?         @relation(fields: [branchId], references: [id])
  openedBy BusinessMember  @relation("OpenedShifts", fields: [openedById], references: [id])
  closedBy BusinessMember? @relation("ClosedShifts", fields: [closedById], references: [id])
  sales    Sale[]

  @@index([businessId])
  @@index([status])
  @@map("cash_shifts")
}

enum ShiftStatus {
  OPEN
  CLOSED
}

model Sale {
  id            String        @id @default(uuid())
  businessId    String        @map("business_id")
  shiftId       String?       @map("shift_id")
  clientId      String?       @map("client_id")
  staffId       String        @map("staff_id")
  status        SaleStatus    @default(COMPLETED)
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod @default(CASH) @map("payment_method")
  cashGiven     Decimal?      @default(0) @map("cash_given") @db.Decimal(10, 2)
  metadata      Json          @default("{}")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  business Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  shift    CashShift?     @relation(fields: [shiftId], references: [id])
  client   User?          @relation("ClientSales", fields: [clientId], references: [id])
  staff    BusinessMember @relation("StaffSales", fields: [staffId], references: [id])
  items    SaleItem[]
  payments Payment[]

  @@index([businessId])
  @@index([createdAt])
  @@map("sales")
}

enum SaleStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
  MERCADOPAGO
}

model SaleItem {
  id         String  @id @default(uuid())
  saleId     String  @map("sale_id")
  productId  String? @map("product_id")
  serviceId  String? @map("service_id")
  name       String
  qty        Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  discount   Decimal @default(0) @db.Decimal(10, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)
  note       String?

  // Relations
  sale    Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([saleId])
  @@map("sale_items")
}

// =============================================
// Reviews & Ratings
// =============================================

model Review {
  id         String    @id @default(uuid())
  businessId String    @map("business_id")
  clientId   String    @map("client_id")
  bookingId  String?   @unique @map("booking_id")
  rating     Int // 1-5
  comment    String?
  reply      String? // Business reply
  repliedAt  DateTime? @map("replied_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   User     @relation(fields: [clientId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  @@index([businessId])
  @@map("reviews")
}

// =============================================
// Packages & Session Tracking
// =============================================

model Package {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  sessions    Int      @default(1)
  expiresIn   Int?     @map("expires_in_days") // Optional expiration in days
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Optional: Which specific service does this package apply to?
  serviceId String? @map("service_id")

  business       Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service        Service?        @relation(fields: [serviceId], references: [id])
  clientPackages ClientPackage[]

  @@index([businessId])
  @@map("packages")
}

model ClientPackage {
  id         String @id @default(uuid())
  businessId String @map("business_id")
  clientId   String @map("client_id")
  packageId  String @map("package_id")

  status PackageStatus @default(ACTIVE)

  totalSessions Int @map("total_sessions")
  usedSessions  Int @default(0) @map("used_sessions")

  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client     User     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  packageDef Package  @relation(fields: [packageId], references: [id])

  // History of usage
  history PackageSession[]

  @@index([clientId])
  @@index([businessId])
  @@map("client_packages")
}

enum PackageStatus {
  ACTIVE
  EXHAUSTED
  EXPIRED
  CANCELLED
}

model PackageSession {
  id              String   @id @default(uuid())
  clientPackageId String   @map("client_package_id")
  bookingId       String?  @map("booking_id") // If it was used via an appointment
  deductedAt      DateTime @default(now()) @map("deducted_at")
  notes           String?

  clientPackage ClientPackage @relation(fields: [clientPackageId], references: [id], onDelete: Cascade)
  booking       Booking?      @relation(fields: [bookingId], references: [id])

  @@index([clientPackageId])
  @@map("package_sessions")
}

// =============================================
// Gift Cards
// =============================================

model GiftCard {
  id            String  @id @default(uuid())
  businessId    String  @map("business_id")
  code          String  @unique // e.g., "AETERNA-84F2-9X"
  purchaserId   String? @map("purchaser_id") // The person who bought it
  recipientName String? @map("recipient_name")

  initialBalance Decimal @map("initial_balance") @db.Decimal(10, 2)
  currentBalance Decimal @map("current_balance") @db.Decimal(10, 2)

  status     GiftCardStatus @default(ACTIVE)
  expiresAt  DateTime?      @map("expires_at")
  createdAt  DateTime       @default(now()) @map("created_at")
  lastUsedAt DateTime?      @map("last_used_at")

  business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  purchaser User?    @relation("GiftCardPurchaser", fields: [purchaserId], references: [id])

  @@index([businessId])
  @@index([code])
  @@map("gift_cards")
}

enum GiftCardStatus {
  ACTIVE
  DEPLETED
  EXPIRED
}

// =============================================
// Loyalty Programs
// =============================================

model LoyaltyProgram {
  id          String      @id @default(uuid())
  businessId  String      @map("business_id")
  name        String
  description String?
  icon        String?     @default("ðŸ’Ž")
  type        LoyaltyType
  config      Json // Points-per-visit, stamps-needed, level-thresholds, etc.
  enabled     Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  business Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  cards    LoyaltyCard[]

  @@index([businessId])
  @@map("loyalty_programs")
}

enum LoyaltyType {
  STAMPS // Digital stamp card
  POINTS // Points per visit/purchase
  TIERS // Bronze/Silver/Gold
}

model LoyaltyCard {
  id               String @id @default(uuid())
  loyaltyProgramId String @map("loyalty_program_id")
  clientId         String @map("client_id")

  // Balances & Metrics
  tier       String @default("BRONCE")
  points     Int    @default(0)
  stamps     Int    @default(0)
  visits     Int    @default(0)
  totalSpent Float  @default(0) @map("total_spent")
  referrals  Int    @default(0)

  lastVisit DateTime? @map("last_visit")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  program LoyaltyProgram @relation(fields: [loyaltyProgramId], references: [id], onDelete: Cascade)
  client  User           @relation(fields: [clientId], references: [id])

  @@unique([loyaltyProgramId, clientId])
  @@map("loyalty_cards")
}

model LoyaltyReward {
  id            String   @id @default(uuid())
  businessId    String   @map("business_id")
  name          String
  pointsCost    Int      @map("points_cost")
  category      String   @default("Servicios")
  isActive      Boolean  @default(true) @map("is_active")
  timesRedeemed Int      @default(0) @map("times_redeemed")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("loyalty_rewards")
}

// =============================================
// Favorites
// =============================================

model Favorite {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  businessId String   @map("business_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@map("favorites")
}

// =============================================
// Gallery (Before/After + Digital Archive)
// =============================================

model GalleryItem {
  id         String      @id @default(uuid())
  businessId String      @map("business_id")
  type       GalleryType
  title      String?
  beforeUrl  String?     @map("before_url")
  afterUrl   String?     @map("after_url")
  fileUrl    String?     @map("file_url") // For digital archive
  mimeType   String?     @map("mime_type")
  isPublic   Boolean     @default(true) @map("is_public")
  sortOrder  Int         @default(0) @map("sort_order")
  createdAt  DateTime    @default(now()) @map("created_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("gallery_items")
}

enum GalleryType {
  BEFORE_AFTER
  PORTFOLIO
  DOCUMENT
}

// =============================================
// Notifications
// =============================================

model Notification {
  id         String              @id @default(uuid())
  userId     String              @map("user_id")
  businessId String?             @map("business_id")
  type       NotificationType
  channel    NotificationChannel
  title      String
  body       String
  data       Json                @default("{}")
  isRead     Boolean             @default(false) @map("is_read")
  sentAt     DateTime?           @map("sent_at")
  createdAt  DateTime            @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business? @relation(fields: [businessId], references: [id])

  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  BOOKING_CONFIRMATION
  BOOKING_REMINDER
  BOOKING_CANCELLED
  BOOKING_RESCHEDULED
  SLOT_AVAILABLE
  PAYMENT_RECEIVED
  REVIEW_REQUEST
  LOYALTY_REWARD
  PROMOTION
  APPOINTMENT_REMINDER
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
  WHATSAPP
}

// =============================================
// Intake Form Overrides (per business)
// =============================================

model IntakeFormOverride {
  id         String   @id @default(uuid())
  businessId String   @map("business_id")
  formSchema Json     @map("form_schema") // Custom JSON schema
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId])
  @@map("intake_form_overrides")
}

// =============================================
// SuperAdmin â€” Code Aeternum Command Center
// =============================================

// =============================================
// Intake Forms (Dynamic Forms Builder)
// =============================================

model FormTemplate {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String
  description String?
  category    String   @default("registro")
  isActive    Boolean  @default(true) @map("is_active")
  fields      Json     @default("[]") // Array of FormFields config
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  business  Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  responses FormResponse[]

  @@index([businessId])
  @@map("form_templates")
}

model FormResponse {
  id           String   @id @default(uuid())
  businessId   String   @map("business_id")
  formId       String   @map("form_id")
  clientId     String?  @map("client_id")
  responseData Json     @default("{}") // The client's filled answers
  submittedAt  DateTime @default(now()) @map("submitted_at")

  business Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  form     FormTemplate @relation(fields: [formId], references: [id], onDelete: Cascade)
  client   User?        @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([formId])
  @@index([businessId])
  @@index([clientId])
  @@map("form_responses")
}

// Feature Flags: Platform-wide module toggles
// Enables Code Aeternum to remotely enable/disable BETA modules
// Example flags: "module_fiscal_vault", "module_xray_viewer", "module_loyalty_v2"
model FeatureFlag {
  id          String  @id @default(uuid())
  key         String  @unique // e.g. "module_fiscal_vault"
  name        String // Display name: "BÃ³veda Fiscal"
  description String? // What this flag controls
  enabled     Boolean @default(false)
  environment String  @default("production") // "production" | "staging" | "development"

  // Targeting: which plans/categories see this flag
  targetPlans      String[] @default([]) // Empty = all plans. ["PRO", "BUSINESS"]
  targetCategories String[] @default([]) // Empty = all categories. ["dental", "medical"]

  // Metadata
  createdBy String?  @map("created_by") // PLATFORM_ADMIN userId
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}

// =============================================
// Health & Medical (EHR) â€” Phase 26
// =============================================

model MedicalRecord {
  id                 String   @id @default(uuid())
  businessId         String   @map("business_id")
  clientId           String   @map("client_id")
  bloodType          String?  @map("blood_type")
  allergies          String?
  chronicConditions  String?  @map("chronic_conditions")
  currentMedications String?  @map("current_medications")
  emergencyContact   String?  @map("emergency_contact")
  notes              String? // Protected practitioner notes
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  // Relations
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        User           @relation("ClientMedicalRecords", fields: [clientId], references: [id], onDelete: Cascade)
  dentalCharts  DentalChart[]
  prescriptions Prescription[]
  bodyCharts    BodyChart[]

  @@unique([businessId, clientId]) // One master record per clinic per patient
  @@index([businessId])
  @@index([clientId])
  @@map("medical_records")
}

// =============================================
// Dental Charts
// =============================================

model DentalChart {
  id              String  @id @default(uuid())
  businessId      String  @map("business_id")
  clientId        String  @map("client_id")
  medicalRecordId String? @map("medical_record_id")

  // Storage for the 32 teeth array (e.g., caries, restorations, missing)
  teethData Json    @default("[]") @map("teeth_data")
  notes     String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        User           @relation("ClientDentalCharts", fields: [clientId], references: [id], onDelete: Cascade)
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([businessId])
  @@index([clientId])
  @@map("dental_charts")
}

// =============================================
// Medical Prescriptions (Recetas)
// =============================================

model Prescription {
  id              String  @id @default(uuid())
  businessId      String  @map("business_id")
  clientId        String  @map("client_id")
  medicalRecordId String? @map("medical_record_id")

  diagnosis  String?
  notes      String?
  doctorName String? @map("doctor_name")

  items PrescriptionItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        User           @relation("ClientPrescriptions", fields: [clientId], references: [id], onDelete: Cascade)
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([businessId])
  @@index([clientId])
  @@map("prescriptions")
}

model PrescriptionItem {
  id             String  @id @default(uuid())
  prescriptionId String  @map("prescription_id")
  medicationName String  @map("medication_name")
  dosage         String // e.g., "500mg"
  frequency      String // e.g., "Cada 8 horas"
  duration       String // e.g., "Por 5 dÃ­as"
  notes          String? // e.g., "Tomar con alimentos"

  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
  @@map("prescription_items")
}

// =============================================
// Body Charts (Mapa AnatÃ³mico)
// =============================================

model BodyChart {
  id              String  @id @default(uuid())
  businessId      String  @map("business_id")
  clientId        String  @map("client_id")
  medicalRecordId String? @map("medical_record_id")

  // Storage for anatomical markers (x, y, label, severity, side)
  markers Json    @default("[]")
  notes   String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        User           @relation("ClientBodyCharts", fields: [clientId], references: [id], onDelete: Cascade)
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([businessId])
  @@index([clientId])
  @@map("body_charts")
}

// Platform Ads: Injectable banners for Free/Starter tier
// Code Aeternum monetizes free-tier businesses with non-intrusive banners
model PlatformAd {
  id        String      @id @default(uuid())
  title     String
  body      String?
  imageUrl  String?     @map("image_url")
  linkUrl   String?     @map("link_url")
  placement AdPlacement @default(DASHBOARD_BANNER)
  isActive  Boolean     @default(true) @map("is_active")

  // Targeting
  targetPlans      String[] @default(["FREE", "STARTER"])
  targetCategories String[] @default([])

  // Scheduling
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  // Metrics
  impressionCount Int @default(0) @map("impression_count")
  clickCount      Int @default(0) @map("click_count")

  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive, placement])
  @@map("platform_ads")
}

enum AdPlacement {
  DASHBOARD_BANNER
  SIDEBAR_WIDGET
  BOOKING_CONFIRMATION
  CALENDAR_INTERSTITIAL
}

// Audit Log: Tracks every SuperAdmin action
model AuditLog {
  id         String   @id @default(uuid())
  actorId    String   @map("actor_id") // PLATFORM_ADMIN userId
  action     String // "TOGGLE_FLAG", "CREATE_AD", "SUSPEND_BUSINESS"
  targetType String   @map("target_type") // "FeatureFlag", "PlatformAd", "Business"
  targetId   String   @map("target_id")
  details    Json     @default("{}") // Any extra context
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Platform Feedback: Bug reports, feature requests, and general feedback
// Businesses submit â†’ SuperAdmin triages and tracks resolution
model PlatformFeedback {
  id            String           @id @default(uuid())
  businessId    String?          @map("business_id")
  userId        String?          @map("user_id") // Who submitted
  type          FeedbackType     @default(GENERAL)
  priority      FeedbackPriority @default(MEDIUM)
  status        FeedbackStatus   @default(OPEN)
  title         String
  description   String
  screenshotUrl String?          @map("screenshot_url")
  adminNotes    String?          @map("admin_notes") // SuperAdmin internal notes
  resolvedAt    DateTime?        @map("resolved_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  @@index([type, status])
  @@index([priority])
  @@index([businessId])
  @@index([createdAt])
  @@map("platform_feedback")
}

enum FeedbackType {
  BUG_REPORT
  FEATURE_REQUEST
  GENERAL
  COMPLAINT
  PRAISE
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  WONT_FIX
  DUPLICATE
}

// =============================================
// Clinical Gallery / Medical Pinterest
// =============================================

model GalleryAlbum {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  clientId    String   @map("client_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  business Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   User           @relation("ClientAlbums", fields: [clientId], references: [id], onDelete: Cascade)
  images   GalleryImage[]

  @@index([businessId])
  @@index([clientId])
  @@map("gallery_albums")
}

model GalleryImage {
  id           String   @id @default(uuid())
  albumId      String   @map("album_id")
  url          String
  thumbnailUrl String?  @map("thumbnail_url")
  notes        String?
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  album       GalleryAlbum      @relation(fields: [albumId], references: [id], onDelete: Cascade)
  annotations ImageAnnotation[]

  @@index([albumId])
  @@map("gallery_images")
}

model ImageAnnotation {
  id      String   @id @default(uuid())
  imageId String   @map("image_id")
  x       Float // Relative X coordinate (0 to 1)
  y       Float // Relative Y coordinate (0 to 1)
  note    String
  color   String   @default("#EF4444") // Highlight color
  addedAt DateTime @default(now()) @map("added_at")

  image GalleryImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([imageId])
  @@map("image_annotations")
}

// =============================================
// Automotive Vertical & Quotations
// =============================================

model Vehicle {
  id           String   @id @default(uuid())
  businessId   String   @map("business_id")
  clientId     String   @map("client_id")
  vin          String?
  make         String
  model        String
  year         Int?
  licensePlate String?  @map("license_plate")
  color        String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client     User        @relation("ClientVehicles", fields: [clientId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]
  quotations Quotation[]

  @@index([businessId])
  @@index([clientId])
  @@index([licensePlate])
  @@map("vehicles")
}

model Device {
  id           String     @id @default(uuid())
  businessId   String     @map("business_id")
  clientId     String     @map("client_id")
  deviceType   DeviceType @default(PHONE) @map("device_type")
  brand        String
  model        String
  serialNumber String?    @map("serial_number")
  imei         String?
  passwordPin  String?    @map("password_pin")
  color        String?
  notes        String?
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client     User        @relation("ClientDevices", fields: [clientId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]
  quotations Quotation[]

  @@index([businessId])
  @@index([clientId])
  @@index([serialNumber])
  @@map("devices")
}

enum DeviceType {
  PHONE
  TABLET
  LAPTOP
  DESKTOP
  CONSOLE
  OTHER
}

model WorkOrder {
  id          String          @id @default(uuid())
  businessId  String          @map("business_id")
  clientId    String          @map("client_id")
  vehicleId   String?         @map("vehicle_id")
  deviceId    String?         @map("device_id")
  status      WorkOrderStatus @default(RECEIVING)
  description String?
  odometer    Int?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  business   Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client     User        @relation("ClientWorkOrders", fields: [clientId], references: [id], onDelete: Cascade)
  vehicle    Vehicle?    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  device     Device?     @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  quotations Quotation[]

  @@index([businessId])
  @@index([clientId])
  @@index([vehicleId])
  @@index([deviceId])
  @@map("work_orders")
}

enum WorkOrderStatus {
  RECEIVING
  DIAGNOSING
  WAITING_PARTS
  REPAIRING
  READY
  DELIVERED
  CANCELLED
}

model Quotation {
  id          String          @id @default(uuid())
  businessId  String          @map("business_id")
  clientId    String          @map("client_id")
  vehicleId   String?         @map("vehicle_id")
  deviceId    String?         @map("device_id")
  workOrderId String?         @map("work_order_id")
  status      QuotationStatus @default(PENDING)
  totalAmount Float           @map("total_amount")
  items       Json
  notes       String?
  expiresAt   DateTime?       @map("expires_at")
  magicLink   String?         @unique @map("magic_link")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  business  Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client    User       @relation("ClientQuotations", fields: [clientId], references: [id], onDelete: Cascade)
  vehicle   Vehicle?   @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  device    Device?    @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([businessId])
  @@index([clientId])
  @@index([deviceId])
  @@index([magicLink])
  @@map("quotations")
}

enum QuotationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}
